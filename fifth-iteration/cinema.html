<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Finder</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Minimal auth modal styles (add to your css file if preferred) */
        .auth-modal, .booking-modal, .movie-modal { display: none; align-items: center; justify-content: center; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; }
        .auth-content { background: #fff; padding: 20px; border-radius: 6px; width: 320px; box-shadow: 0 6px 18px rgba(0,0,0,0.2); }
        .auth-actions { display:flex; gap:8px; margin-top:12px; }
        .auth-input { width:100%; padding:8px; margin-top:6px; }
        .auth-tab { display:inline-block; padding:6px 10px; cursor:pointer; border-bottom:2px solid transparent; }
        .auth-tab.active { border-bottom-color:#0078d4; font-weight:600; }
        .header-controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
        .nav-button, .small-btn { padding:6px 10px; border-radius:4px; background:#0078d4; color:#fff; text-decoration:none; border:none; cursor:pointer; }
        .small-btn.secondary { background:#6c6c6c; }
    </style>
</head>
<body>
    <div class="container">
        <header style="display:flex;align-items:center;gap:16px;">
            <div>
                <h1>üé≠ Cinema Finder</h1>
                <p>Discover cinemas and movies showing near you</p>
            </div>

            <div class="header-controls" id="headerControls">
                <a href="locations.html" class="nav-button">View Locations</a>
                <!-- auth area will be populated by JS -->
                <div id="authArea"></div>
            </div>
        </header>

        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <div class="search-container">
                <input type="text" id="movieSearch" placeholder="Search movies by title..." class="search-input">
                <button onclick="searchMovies()" class="search-btn">üîç Search</button>
            </div>
            <div class="filter-container">
                <select id="genreFilter" onchange="filterMovies()" class="filter-select">
                    <option value="">All Genres</option>
                    <option value="Sci-Fi">Sci-Fi</option>
                    <option value="Action">Action</option>
                    <option value="Comedy">Comedy</option>
                    <option value="Drama">Drama</option>
                    <option value="Biography">Biography</option>
                    <option value="Crime">Crime</option>
                    <option value="Animation">Animation</option>
                    <option value="Adventure">Adventure</option>
                    <option value="Fantasy">Fantasy</option>
                </select>
                <select id="ratingFilter" onchange="filterMovies()" class="filter-select">
                    <option value="">All Ratings</option>
                    <option value="9">9+ ‚≠ê</option>
                    <option value="8">8+ ‚≠ê</option>
                    <option value="7">7+ ‚≠ê</option>
                    <option value="6">6+ ‚≠ê</option>
                </select>
                <button onclick="clearFilters()" class="clear-filters-btn">Clear Filters</button>
            </div>
        </div>
        </header>

        <div class="cinemas-grid" id="cinemas-container"></div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="booking-modal">
        <div class="booking-content">
            <button class="close-btn" onclick="closeBooking()">&times;</button>
            <h2>Book Your Tickets</h2>
            <div class="booking-details">
                <p><strong>Cinema:</strong> <span id="bookingCinema"></span></p>
                <p><strong>Movie:</strong> <span id="bookingMovie"></span></p>
                <p><strong>Time:</strong> <span id="bookingTime"></span></p>
            </div>
            
            <div class="seats-selection">
                <h3>Select Seats</h3>
                <div class="screen">SCREEN</div>
                <div class="seat-grid" id="seatGrid"></div>
            </div>

            <!-- Concessions Section -->
            <div class="concessions-section">
                <h3>Add Snacks & Drinks</h3>
                <div class="concessions-grid" id="concessionsGrid">
                    <!-- Concessions will be populated by JavaScript -->
                </div>
            </div>

            <!-- Promo Code Section -->
            <div class="promo-section">
                <h3>Promo Code</h3>
                <div class="promo-container">
                    <input type="text" id="promoCode" placeholder="Enter promo code" class="promo-input">
                    <button onclick="applyPromoCode()" class="promo-btn">Apply</button>
                </div>
                <div id="promoMessage" class="promo-message"></div>
            </div>

            <div class="booking-summary">
                <p>Selected Seats: <span id="selectedSeatsDisplay">None</span></p>
                <p>Ticket Price: <span id="ticketPrice">$0</span></p>
                <p>Concessions: <span id="concessionsPrice">$0</span></p>
                <p>Total Price: <span id="totalPrice">$0</span></p>
            </div>

            <button class="confirm-btn" onclick="confirmBooking()">Confirm Booking</button>
        </div>
    </div>

    <!-- Movie Details Modal -->
    <div id="movieModal" class="movie-modal">
        <div class="movie-modal-content">
            <button class="close-btn" onclick="closeMovieDetails()">&times;</button>
            <div class="movie-trailer-container">
                <iframe id="movieTrailer" class="movie-trailer" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <div class="movie-details-header">
                <h2 id="movieModalTitle"></h2>
                <div class="movie-meta">
                    <span class="movie-badge" id="movieGenre"></span>
                    <span class="movie-badge rating-badge">
                        <span class="rating-star">‚≠ê</span>
                        <span id="movieRating"></span>
                        <span id="userRatingText"></span>
                    </span>
                    <span class="movie-badge">
                        <span id="movieDuration"></span>
                    </span>
                    <span class="movie-badge" id="totalReviews"></span>
                </div>
            </div>
            <div class="movie-description" id="movieDescription"></div>
            
            <!-- User Review Section -->
            <div class="review-section">
                <h3>Write a Review</h3>
                <div id="userReviewForm" style="display: none;">
                    <div class="rating-input">
                        <label>Your Rating:</label>
                        <div class="star-rating" id="starRating">
                            <span class="star" data-rating="1">‚≠ê</span>
                            <span class="star" data-rating="2">‚≠ê</span>
                            <span class="star" data-rating="3">‚≠ê</span>
                            <span class="star" data-rating="4">‚≠ê</span>
                            <span class="star" data-rating="5">‚≠ê</span>
                        </div>
                    </div>
                    <div class="review-textarea">
                        <textarea id="reviewText" placeholder="Share your thoughts about this movie..."></textarea>
                    </div>
                    <button onclick="submitReview()" class="submit-review-btn">Submit Review</button>
                </div>
                <div id="loginPrompt" style="display: none;">
                    <p>Please <a href="#" onclick="openAuth('login'); closeMovieDetails();">login</a> to write a review.</p>
                </div>
            </div>
            
            <!-- Reviews List -->
            <div class="reviews-list">
                <h3>User Reviews</h3>
                <div id="reviewsContainer">
                    <p class="no-reviews">No reviews yet. Be the first to review this movie!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal (Login / Register) -->
    <div id="authModal" class="auth-modal">
        <div class="auth-content">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <span id="tabLogin" class="auth-tab active" onclick="switchAuthTab('login')">Login</span>
                    <span id="tabRegister" class="auth-tab" onclick="switchAuthTab('register')">Register</span>
                </div>
                <button class="close-btn" onclick="closeAuth()">&times;</button>
            </div>

            <form id="loginForm" style="margin-top:12px;" onsubmit="event.preventDefault(); loginUser();">
                <input id="loginUsername" class="auth-input" placeholder="Username" required>
                <input id="loginPassword" type="password" class="auth-input" placeholder="Password" required>
                <div class="auth-actions">
                    <button type="submit" class="nav-button">Login</button>
                    <button type="button" class="small-btn secondary" onclick="switchAuthTab('register')">Go to Register</button>
                </div>
            </form>

            <form id="registerForm" style="margin-top:12px; display:none;" onsubmit="event.preventDefault(); registerUser();">
                <input id="regUsername" class="auth-input" placeholder="Choose username" required>
                <input id="regPassword" type="password" class="auth-input" placeholder="Password (min 4 chars)" required>
                <input id="regPasswordConfirm" type="password" class="auth-input" placeholder="Confirm password" required>
                <div class="auth-actions">
                    <button type="submit" class="nav-button">Register & Login</button>
                    <button type="button" class="small-btn secondary" onclick="switchAuthTab('login')">Back to Login</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let selectedSeats = [];
        const SEAT_PRICE = 12; // Price per seat in dollars
        let movieDatabase = {}; // Store all movies for easy lookup
        let selectedConcessions = {}; // Store selected concessions with quantities
        let appliedPromo = null; // Store applied promo code

        // Concessions data
        const concessions = [
            { id: 'popcorn_small', name: 'Popcorn (Small)', icon: 'üçø', price: 5 },
            { id: 'popcorn_medium', name: 'Popcorn (Medium)', icon: 'üçø', price: 7 },
            { id: 'popcorn_large', name: 'Popcorn (Large)', icon: 'üçø', price: 9 },
            { id: 'soda_small', name: 'Soda (Small)', icon: 'ü•§', price: 4 },
            { id: 'soda_medium', name: 'Soda (Medium)', icon: 'ü•§', price: 5 },
            { id: 'soda_large', name: 'Soda (Large)', icon: 'ü•§', price: 6 },
            { id: 'candy', name: 'Candy', icon: 'üç¨', price: 3 },
            { id: 'nachos', name: 'Nachos', icon: 'üåÆ', price: 8 },
            { id: 'hotdog', name: 'Hot Dog', icon: 'üå≠', price: 6 },
            { id: 'water', name: 'Water', icon: 'üíß', price: 3 },
            { id: 'combo', name: 'Combo Deal', icon: 'üéÅ', price: 12 }
        ];

        // Promo codes data
        const promoCodes = {
            'FIRST10': { discount: 10, type: 'percentage', description: '10% off your first booking' },
            'MOVIE20': { discount: 20, type: 'percentage', description: '20% off on movie tickets' },
            'SNACKS15': { discount: 15, type: 'percentage', description: '15% off on concessions' },
            'FLAT5': { discount: 5, type: 'fixed', description: '$5 off your order' },
            'WEEKEND': { discount: 25, type: 'percentage', description: '25% off weekend bookings' },
            'STUDENT': { discount: 15, type: 'percentage', description: '15% student discount' },
            'FAMILY': { discount: 10, type: 'percentage', description: '10% family discount (3+ tickets)' },
            'DATE50': { discount: 50, type: 'fixed', maxDiscount: 25, description: '$50 off (max $25 discount)' }
        };

        // Sample cinema data
        const cinemas = [
            {
                id: 1,
                name: "Paramount Cineplex",
                location: "Downtown Center, Main Street",
                rating: 4.5,
                image: "images/background-a-movie-theater-where-love-stories-are-unfolding-on-the-big-screen-and-the-smell-of-popcorn-fills-the-air-photo.jpg",
                movies: [
                    {
                        title: "Dune: Part Two",
                        genre: "Sci-Fi/Adventure",
                        rating: 8.2,
                        duration: "166 minutes",
                        description: "An epic continuation of the sci-fi saga. Paul Atreides travels to the dangerous planet Arrakis to protect the future of his family and people.",
                        trailer: "https://www.youtube.com/embed/Way9Dexny3w",
                        times: ["2:30 PM", "5:15 PM", "8:00 PM", "10:45 PM"]
                    },
                    {
                        title: "Oppenheimer",
                        genre: "Biography/Drama",
                        rating: 8.5,
                        duration: "180 minutes",
                        description: "The story of American scientist J. Robert Oppenheimer and his role in the development of the atomic bomb during World War II.",
                        trailer: "https://www.youtube.com/embed/uYPbbksJxIg",
                        times: ["1:45 PM", "4:20 PM", "7:00 PM", "9:30 PM"]
                    },
                    {
                        title: "Killers of the Flower Moon",
                        genre: "Drama/Crime",
                        rating: 8.0,
                        duration: "206 minutes",
                        description: "A Western crime drama following the FBI investigation into murders of Osage Nation members in 1920s Oklahoma.",
                        trailer: "https://www.youtube.com/embed/n8f8Ek5LvEo",
                        times: ["3:00 PM", "6:30 PM", "9:15 PM"]
                    }
                ]
            },
            {
                id: 2,
                name: "Star Theatre Plaza",
                location: "Riverside Mall, Oak Avenue",
                rating: 4.7,
                image: "images/gettyimages-187137230-612x612.jpg",
                movies: [
                    {
                        title: "Dune: Part Two",
                        genre: "Sci-Fi/Adventure",
                        rating: 8.2,
                        duration: "166 minutes",
                        description: "An epic continuation of the sci-fi saga. Paul Atreides travels to the dangerous planet Arrakis to protect the future of his family and people.",
                        times: ["2:00 PM", "5:00 PM", "8:00 PM"]
                    },
                    {
                        title: "Barbie",
                        genre: "Comedy/Fantasy",
                        rating: 7.9,
                        duration: "114 minutes",
                        description: "Barbie escapes her perfect pink world and sets out on a journey to discover what it means to be human in the real world.",
                        trailer: "https://www.youtube.com/embed/HHKwAJ9kj6U",
                        times: ["1:30 PM", "4:15 PM", "7:30 PM", "10:00 PM"]
                    },
                    {
                        title: "Killers of the Flower Moon",
                        genre: "Drama/Crime",
                        rating: 8.0,
                        duration: "206 minutes",
                        description: "A Western crime drama following the FBI investigation into murders of Osage Nation members in 1920s Oklahoma.",
                        times: ["3:45 PM", "6:15 PM", "9:00 PM"]
                    },
                    {
                        title: "The Hunger Games: Ballad of Songbirds and Snakes",
                        genre: "Action/Adventure",
                        rating: 7.7,
                        duration: "157 minutes",
                        description: "A prequel to The Hunger Games, following young Coriolanus Snow as he navigates the 10th Hunger Games as a mentor.",
                        times: ["2:15 PM", "5:30 PM", "8:45 PM"]
                    }
                ]
            },
            {
                id: 3,
                name: "Galaxy IMAX",
                location: "Tech Park, Highway 5",
                rating: 4.6,
                image: "images/images.jpg",
                movies: [
                    {
                        title: "Oppenheimer",
                        genre: "Biography/Drama",
                        rating: 8.5,
                        duration: "180 minutes",
                        description: "The story of American scientist J. Robert Oppenheimer and his role in the development of the atomic bomb during World War II.",
                        times: ["2:45 PM", "5:45 PM", "9:00 PM"]
                    },
                    {
                        title: "Dune: Part Two",
                        genre: "Sci-Fi/Adventure",
                        rating: 8.2,
                        duration: "166 minutes",
                        description: "An epic continuation of the sci-fi saga. Paul Atreides travels to the dangerous planet Arrakis to protect the future of his family and people.",
                        times: ["1:15 PM", "4:00 PM", "6:45 PM", "9:30 PM"]
                    },
                    {
                        title: "Elemental",
                        genre: "Animation/Adventure",
                        rating: 7.8,
                        duration: "101 minutes",
                        description: "In a city where fire, water, land and air residents live together, a tense relationship between firefighter Ember and water droplet Wade leads to an unlikely partnership.",
                        trailer: "https://www.youtube.com/embed/RrDlX4sD8r8",
                        times: ["3:30 PM", "7:00 PM", "10:15 PM"]
                    }
                ]
            },
            {
                id: 4,
                name: "Sunrise Cinema",
                location: "Shopping District, Park Road",
                rating: 4.3,
                image: "images/pexels-photo-7991579.jpeg",
                movies: [
                    {
                        title: "The Hunger Games: Ballad of Songbirds and Snakes",
                        genre: "Action/Adventure",
                        rating: 7.7,
                        duration: "157 minutes",
                        description: "A prequel to The Hunger Games, following young Coriolanus Snow as he navigates the 10th Hunger Games as a mentor.",                        trailer: "https://www.youtube.com/embed/0X7zox0FjFM",                        times: ["2:00 PM", "5:15 PM", "8:30 PM"]
                    },
                    {
                        title: "Barbie",
                        genre: "Comedy/Fantasy",
                        rating: 7.9,
                        duration: "114 minutes",
                        description: "Barbie escapes her perfect pink world and sets out on a journey to discover what it means to be human in the real world.",
                        times: ["1:45 PM", "4:30 PM", "7:15 PM", "9:45 PM"]
                    }
                ]
            },
            {
                id: 5,
                name: "Neon Lights Cinema",
                location: "Central Business District",
                rating: 4.8,
                image: "images/photo-1595769816263-9b910be24d5f.avif",
                movies: [
                    {
                        title: "Dune: Part Two",
                        genre: "Sci-Fi/Adventure",
                        rating: 8.2,
                        duration: "166 minutes",
                        description: "An epic continuation of the sci-fi saga. Paul Atreides travels to the dangerous planet Arrakis to protect the future of his family and people.",
                        times: ["1:30 PM", "4:45 PM", "7:30 PM", "10:00 PM"]
                    },
                    {
                        title: "Oppenheimer",
                        genre: "Biography/Drama",
                        rating: 8.5,
                        duration: "180 minutes",
                        description: "The story of American scientist J. Robert Oppenheimer and his role in the development of the atomic bomb during World War II.",
                        times: ["2:15 PM", "5:00 PM", "8:15 PM"]
                    },
                    {
                        title: "Elemental",
                        genre: "Animation/Adventure",
                        rating: 7.8,
                        duration: "101 minutes",
                        description: "In a city where fire, water, land and air residents live together, a tense relationship between firefighter Ember and water droplet Wade leads to an unlikely partnership.",
                        times: ["3:00 PM", "6:00 PM", "9:00 PM"]
                    },
                    {
                        title: "Killers of the Flower Moon",
                        genre: "Drama/Crime",
                        rating: 8.0,
                        duration: "206 minutes",
                        description: "A Western crime drama following the FBI investigation into murders of Osage Nation members in 1920s Oklahoma.",
                        times: ["2:45 PM", "5:30 PM", "8:45 PM"]
                    }
                ]
            }
        ];

        // Function to render cinema cards
        function renderCinemas(filteredCinemas = null) {
            const container = document.getElementById('cinemas-container');
            container.innerHTML = '';
            movieDatabase = {}; // Clear and rebuild movie database

            const cinemasToRender = filteredCinemas || cinemas;
            
            cinemasToRender.forEach(cinema => {
                const card = document.createElement('div');
                card.className = 'cinema-card';

                const stars = '‚≠ê'.repeat(Math.floor(cinema.rating));
                const moviesHTML = cinema.movies.length > 0
                    ? cinema.movies.map((movie, index) => {
                        const movieId = `movie_${cinema.id}_${index}`;
                        // Store movie details in database
                        movieDatabase[movieId] = {
                            title: movie.title,
                            genre: movie.genre,
                            rating: movie.rating,
                            duration: movie.duration,
                            description: movie.description,
                            trailer: movie.trailer
                        };
                        return `
                        <div class="movie-item">
                            <div class="movie-name">${movie.title}</div>
                            <div class="movie-actions">
                                <button class="details-btn" onclick="openMovieDetailsById('${movieId}')">View Details</button>
                                <button class="favorite-btn" id="fav_${movieId}" onclick="toggleFavorite('${movieId}', '${movie.title.replace(/'/g, "\\'")}', '${movie.genre}', '${movie.rating}', '${movie.duration}', '${(movie.description || '').replace(/'/g, "\\'")}')">
                                    <span class="fav-icon">‚ù§Ô∏è</span>
                                    <span class="fav-text">Add to Favorites</span>
                                </button>
                            </div>
                            <div class="movie-times">
                                ${movie.times.map(time => `<span class="time-badge" onclick="openBooking('${cinema.name.replace(/'/g, "\\'")}', '${movie.title.replace(/'/g, "\\'")}', '${time}')">${time}</span>`).join('')}
                            </div>
                        </div>
                    `}).join('')
                    : '<div class="no-movies">No movies showing currently</div>';

                card.innerHTML = `
                    <div class="cinema-image" style="background-image: url('${cinema.image}')"></div>
                    <div class="cinema-header">
                        <div class="cinema-name">${cinema.name}</div>
                        <div class="cinema-location">${cinema.location}</div>
                        <div class="rating">
                            <span class="rating-star">${stars}</span>
                            ${cinema.rating}
                        </div>
                    </div>
                    <div class="movies-section">
                        <div class="movies-title">Now Showing</div>
                        ${moviesHTML}
                    </div>
                `;

                container.appendChild(card);
            });
            
            // Update favorite button states
            setTimeout(updateFavoriteButtons, 100);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            renderCinemas();
            refreshAuthUI();
        });

        // Booking functions
        function openBooking(cinemaName, movieTitle, time) {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                openAuth('login');
                return;
            }

            selectedSeats = [];
            document.getElementById('bookingCinema').textContent = cinemaName;
            document.getElementById('bookingMovie').textContent = movieTitle;
            document.getElementById('bookingTime').textContent = time;
            document.getElementById('bookingModal').style.display = 'flex';
            generateSeats();
            renderConcessions();
        }

        function closeBooking() {
            document.getElementById('bookingModal').style.display = 'none';
            selectedSeats = [];
            selectedConcessions = {};
            appliedPromo = null;
            document.getElementById('promoCode').value = '';
            document.getElementById('promoMessage').className = 'promo-message';
            document.getElementById('promoMessage').textContent = '';
            updateBookingSummary();
        }

        // Promo code functions
        function applyPromoCode() {
            const promoInput = document.getElementById('promoCode');
            const code = promoInput.value.trim().toUpperCase();
            const messageElement = document.getElementById('promoMessage');

            if (!code) {
                showPromoMessage('Please enter a promo code', 'error');
                return;
            }

            if (promoCodes[code]) {
                // Check if promo can be applied
                const promo = promoCodes[code];
                
                if (promo.type === 'percentage' && promo.discount > 50) {
                    showPromoMessage('Invalid promo code', 'error');
                    return;
                }

                if (promo.type === 'fixed' && promo.discount > 100) {
                    showPromoMessage('Invalid promo code', 'error');
                    return;
                }

                appliedPromo = { code, ...promo };
                showPromoMessage(`Promo code applied! ${promo.description}`, 'success');
                updateBookingSummary();
            } else {
                showPromoMessage('Invalid promo code', 'error');
                appliedPromo = null;
                updateBookingSummary();
            }
        }

        function showPromoMessage(message, type) {
            const messageElement = document.getElementById('promoMessage');
            messageElement.textContent = message;
            messageElement.className = `promo-message ${type}`;
        }

        function calculateDiscount(subtotal) {
            if (!appliedPromo) return 0;

            let discount = 0;
            const promo = appliedPromo;

            if (promo.type === 'percentage') {
                discount = subtotal * (promo.discount / 100);
            } else if (promo.type === 'fixed') {
                discount = promo.discount;
            }

            // Apply maximum discount limit if specified
            if (promo.maxDiscount && discount > promo.maxDiscount) {
                discount = promo.maxDiscount;
            }

            // Ensure discount doesn't exceed subtotal
            if (discount > subtotal) {
                discount = subtotal;
            }

            return discount;
        }

        function renderConcessions() {
            const concessionsGrid = document.getElementById('concessionsGrid');
            concessionsGrid.innerHTML = concessions.map(item => `
                <div class="concession-item" id="concession_${item.id}" onclick="toggleConcession('${item.id}')">
                    <div class="concession-icon">${item.icon}</div>
                    <div class="concession-name">${item.name}</div>
                    <div class="concession-price">$${item.price}</div>
                    <div class="concession-quantity">
                        <button class="quantity-btn" onclick="event.stopPropagation(); changeQuantity('${item.id}', -1)">-</button>
                        <span class="quantity-display" id="qty_${item.id}">0</span>
                        <button class="quantity-btn" onclick="event.stopPropagation(); changeQuantity('${item.id}', 1)">+</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleConcession(itemId) {
            const concession = concessions.find(c => c.id === itemId);
            if (!concession) return;

            if (!selectedConcessions[itemId]) {
                selectedConcessions[itemId] = { ...concession, quantity: 1 };
            } else {
                if (selectedConcessions[itemId].quantity === 0) {
                    selectedConcessions[itemId].quantity = 1;
                } else {
                    selectedConcessions[itemId].quantity = 0;
                }
            }

            updateConcessionsDisplay();
            updateBookingSummary();
        }

        function changeQuantity(itemId, delta) {
            if (!selectedConcessions[itemId]) {
                selectedConcessions[itemId] = { ...concessions.find(c => c.id === itemId), quantity: 0 };
            }

            const newQuantity = selectedConcessions[itemId].quantity + delta;
            if (newQuantity >= 0 && newQuantity <= 10) { // Max 10 of each item
                selectedConcessions[itemId].quantity = newQuantity;
            }

            updateConcessionsDisplay();
            updateBookingSummary();
        }

        function updateConcessionsDisplay() {
            Object.keys(selectedConcessions).forEach(itemId => {
                const quantity = selectedConcessions[itemId].quantity;
                document.getElementById(`qty_${itemId}`).textContent = quantity;
                
                const concessionElement = document.getElementById(`concession_${itemId}`);
                if (quantity > 0) {
                    concessionElement.classList.add('selected');
                } else {
                    concessionElement.classList.remove('selected');
                }
            });
        }

        function generateSeats() {
            const seatGrid = document.getElementById('seatGrid');
            seatGrid.innerHTML = '';
            const rows = 6;
            const seatsPerRow = 8;

            for (let row = 0; row < rows; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'seat-row';

                for (let seat = 0; seat < seatsPerRow; seat++) {
                    const seatBtn = document.createElement('button');
                    const seatId = String.fromCharCode(65 + row) + (seat + 1);
                    seatBtn.className = 'seat';
                    seatBtn.textContent = seatId;
                    seatBtn.onclick = () => toggleSeat(seatId, seatBtn);
                    rowDiv.appendChild(seatBtn);
                }

                seatGrid.appendChild(rowDiv);
            }
        }

        function toggleSeat(seatId, element) {
            if (selectedSeats.includes(seatId)) {
                selectedSeats = selectedSeats.filter(s => s !== seatId);
                element.classList.remove('selected');
            } else {
                selectedSeats.push(seatId);
                element.classList.add('selected');
            }
            updateBookingSummary();
        }

        function updateBookingSummary() {
            const display = selectedSeats.length > 0 ? selectedSeats.sort().join(', ') : 'None';
            document.getElementById('selectedSeatsDisplay').textContent = display;
            
            const ticketPrice = selectedSeats.length * SEAT_PRICE;
            document.getElementById('ticketPrice').textContent = `$${ticketPrice}`;
            
            const concessionsPrice = Object.values(selectedConcessions)
                .filter(concession => concession.quantity > 0)
                .reduce((total, concession) => total + (concession.price * concession.quantity), 0);
            document.getElementById('concessionsPrice').textContent = `$${concessionsPrice}`;
            
            const subtotal = ticketPrice + concessionsPrice;
            const discount = calculateDiscount(subtotal);
            const totalPrice = subtotal - discount;
            
            document.getElementById('totalPrice').textContent = `$${totalPrice}`;
            
            // Update total price display to show discount
            if (discount > 0) {
                const discountPercent = appliedPromo ? 
                    (appliedPromo.type === 'percentage' ? appliedPromo.discount : Math.round((discount/subtotal) * 100)) : 0;
                document.getElementById('totalPrice').innerHTML = `
                    <span style="text-decoration: line-through; color: #999; font-size: 0.9em;">$${subtotal}</span>
                    <span style="color: #28a745; font-weight: bold;"> $${totalPrice}</span>
                    <span style="color: #28a745; font-size: 0.8em;"> (-${discountPercent}%)</span>
                `;
            } else {
                document.getElementById('totalPrice').textContent = `$${totalPrice}`;
            }
        }

        function confirmBooking() {
            if (selectedSeats.length === 0) {
                alert('Please select at least one seat');
                return;
            }

            const cinema = document.getElementById('bookingCinema').textContent;
            const movie = document.getElementById('bookingMovie').textContent;
            const time = document.getElementById('bookingTime').textContent;
            const seats = selectedSeats.sort().join(', ');
            const ticketPrice = selectedSeats.length * SEAT_PRICE;
            
            const concessionsList = Object.values(selectedConcessions)
                .filter(concession => concession.quantity > 0)
                .map(concession => `${concession.name} x${concession.quantity}`)
                .join(', ');
            
            const concessionsPrice = Object.values(selectedConcessions)
                .filter(concession => concession.quantity > 0)
                .reduce((total, concession) => total + (concession.price * concession.quantity), 0);
            
            const subtotal = ticketPrice + concessionsPrice;
            const discount = calculateDiscount(subtotal);
            const total = subtotal - discount;
            const user = localStorage.getItem('loggedInUser') || 'Guest';

            // Save booking to user profile
            if (user !== 'Guest') {
                const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');
                if (users[user]) {
                    if (!users[user].bookings) {
                        users[user].bookings = [];
                    }
                    
                    const booking = {
                        cinema,
                        movie,
                        time,
                        seats,
                        concessions: concessionsList,
                        ticketPrice,
                        concessionsPrice,
                        subtotal,
                        discount,
                        promoCode: appliedPromo ? appliedPromo.code : null,
                        total,
                        date: new Date().toLocaleDateString(),
                        status: 'upcoming',
                        bookedAt: new Date().toISOString()
                    };
                    
                    users[user].bookings.push(booking);
                    localStorage.setItem('cinemaUsers', JSON.stringify(users));
                }
            }

            let confirmationMessage = `Booking Confirmed!\n\nUser: ${user}\nCinema: ${cinema}\nMovie: ${movie}\nTime: ${time}\nSeats: ${seats}`;
            if (concessionsList) {
                confirmationMessage += `\nConcessions: ${concessionsList}`;
            }
            confirmationMessage += `\n\nTicket Price: $${ticketPrice}`;
            if (concessionsPrice > 0) {
                confirmationMessage += `\nConcessions: $${concessionsPrice}`;
            }
            confirmationMessage += `\nSubtotal: $${subtotal}`;
            if (discount > 0) {
                confirmationMessage += `\nDiscount: -$${discount} (${appliedPromo.code})`;
            }
            confirmationMessage += `\nTotal: $${total}\n\nThank you for your booking!`;
            
            alert(confirmationMessage);
            closeBooking();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('bookingModal');
            const movieModal = document.getElementById('movieModal');
            const authModal = document.getElementById('authModal');
            if (event.target == modal) {
                closeBooking();
            }
            if (event.target == movieModal) {
                closeMovieDetails();
            }
            if (event.target == authModal) {
                closeAuth();
            }
        }

        // Movie Details Functions
        function openMovieDetailsById(movieId) {
            const movie = movieDatabase[movieId];
            if (movie) {
                document.getElementById('movieModalTitle').textContent = movie.title;
                document.getElementById('movieGenre').textContent = movie.genre;
                document.getElementById('movieRating').textContent = movie.rating;
                document.getElementById('movieDuration').textContent = movie.duration;
                document.getElementById('movieDescription').textContent = movie.description || 'No description available.';
                if (movie.trailer) {
                    document.getElementById('movieTrailer').src = movie.trailer;
                }
                
                // Load reviews for this movie
                loadMovieReviews(movie.title, movie.rating);
                
                document.getElementById('movieModal').style.display = 'flex';
            }
        }

        // Review Functions
        let currentMovieTitle = '';
        let userRating = 0;

        function loadMovieReviews(movieTitle, baseRating) {
            currentMovieTitle = movieTitle;
            
            // Get reviews from localStorage
            const reviews = JSON.parse(localStorage.getItem('movieReviews') || '{}');
            const movieReviews = reviews[movieTitle] || [];
            
            // Calculate average rating
            let avgRating = baseRating;
            if (movieReviews.length > 0) {
                const totalRating = movieReviews.reduce((sum, review) => sum + review.rating, 0);
                avgRating = (totalRating / movieReviews.length).toFixed(1);
            }
            
            // Update rating display
            document.getElementById('userRatingText').textContent = `(${avgRating} avg)`;
            document.getElementById('totalReviews').textContent = `${movieReviews.length} reviews`;
            
            // Show review form or login prompt
            const user = localStorage.getItem('loggedInUser');
            const reviewForm = document.getElementById('userReviewForm');
            const loginPrompt = document.getElementById('loginPrompt');
            
            if (user) {
                reviewForm.style.display = 'block';
                loginPrompt.style.display = 'none';
                
                // Check if user already reviewed this movie
                const existingReview = movieReviews.find(review => review.user === user);
                if (existingReview) {
                    displayExistingReview(existingReview);
                } else {
                    resetReviewForm();
                }
            } else {
                reviewForm.style.display = 'none';
                loginPrompt.style.display = 'block';
            }
            
            // Display reviews
            displayReviews(movieReviews);
            
            // Setup star rating
            setupStarRating();
        }

        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.onclick = () => {
                    userRating = parseInt(star.dataset.rating);
                    updateStarDisplay(userRating);
                };
                star.onmouseover = () => {
                    const hoverRating = parseInt(star.dataset.rating);
                    updateStarDisplay(hoverRating);
                };
            });
            
            document.getElementById('starRating').onmouseleave = () => {
                updateStarDisplay(userRating);
            };
        }

        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function displayExistingReview(review) {
            document.getElementById('reviewText').value = review.text;
            userRating = review.rating;
            updateStarDisplay(userRating);
            document.querySelector('.submit-review-btn').textContent = 'Update Review';
        }

        function resetReviewForm() {
            document.getElementById('reviewText').value = '';
            userRating = 0;
            updateStarDisplay(0);
            document.querySelector('.submit-review-btn').textContent = 'Submit Review';
        }

        function submitReview() {
            const user = localStorage.getItem('loggedInUser');
            if (!user) {
                alert('Please login to submit a review');
                return;
            }
            
            if (userRating === 0) {
                alert('Please select a rating');
                return;
            }
            
            const reviewText = document.getElementById('reviewText').value.trim();
            if (!reviewText) {
                alert('Please write a review');
                return;
            }
            
            // Get existing reviews
            const reviews = JSON.parse(localStorage.getItem('movieReviews') || '{}');
            const movieReviews = reviews[currentMovieTitle] || [];
            
            // Check if user already reviewed this movie
            const existingIndex = movieReviews.findIndex(review => review.user === user);
            const review = {
                user,
                rating: userRating,
                text: reviewText,
                date: new Date().toISOString()
            };
            
            if (existingIndex >= 0) {
                movieReviews[existingIndex] = review;
                alert('Review updated successfully!');
            } else {
                movieReviews.push(review);
                alert('Review submitted successfully!');
            }
            
            // Save reviews
            reviews[currentMovieTitle] = movieReviews;
            localStorage.setItem('movieReviews', JSON.stringify(reviews));
            
            // Reload reviews
            const baseRating = movieDatabase[Object.keys(movieDatabase).find(key => 
                movieDatabase[key].title === currentMovieTitle)]?.rating || 0;
            loadMovieReviews(currentMovieTitle, baseRating);
        }

        function displayReviews(reviews) {
            const container = document.getElementById('reviewsContainer');
            
            if (reviews.length === 0) {
                container.innerHTML = '<p class="no-reviews">No reviews yet. Be the first to review this movie!</p>';
                return;
            }
            
            // Sort reviews by date (newest first)
            const sortedReviews = reviews.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedReviews.map(review => `
                <div class="review-item">
                    <div class="review-header">
                        <div class="review-author">${escapeHtml(review.user)}</div>
                        <div class="review-date">${new Date(review.date).toLocaleDateString()}</div>
                    </div>
                    <div class="review-rating">${'‚≠ê'.repeat(review.rating)}</div>
                    <div class="review-text">${escapeHtml(review.text)}</div>
                </div>
            `).join('');
        }

        function closeMovieDetails() {
            document.getElementById('movieModal').style.display = 'none';
            document.getElementById('movieTrailer').src = '';
        }

        // Favorites Functions
        function toggleFavorite(movieId, title, genre, rating, duration, description) {
            const user = localStorage.getItem('loggedInUser');
            if (!user) {
                alert('Please login to add movies to favorites');
                openAuth('login');
                return;
            }

            const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');
            const userData = users[user] || {};
            userData.favorites = userData.favorites || [];

            const favoriteIndex = userData.favorites.findIndex(fav => fav.movieId === movieId);
            const favButton = document.getElementById(`fav_${movieId}`);

            if (favoriteIndex >= 0) {
                // Remove from favorites
                userData.favorites.splice(favoriteIndex, 1);
                favButton.classList.remove('favorited');
                favButton.querySelector('.fav-text').textContent = 'Add to Favorites';
                alert(`"${title}" removed from favorites`);
            } else {
                // Add to favorites
                userData.favorites.push({
                    movieId,
                    title,
                    genre,
                    rating: parseFloat(rating),
                    duration,
                    description,
                    addedAt: new Date().toISOString()
                });
                favButton.classList.add('favorited');
                favButton.querySelector('.fav-text').textContent = 'Remove from Favorites';
                alert(`"${title}" added to favorites`);
            }

            users[user] = userData;
            localStorage.setItem('cinemaUsers', JSON.stringify(users));
        }

        function checkFavoriteStatus(movieId) {
            const user = localStorage.getItem('loggedInUser');
            if (!user) return false;

            const users = JSON.parse(localStorage.getItem('cinemaUsers') || '{}');
            const userData = users[user] || {};
            userData.favorites = userData.favorites || [];

            const isFavorite = userData.favorites.some(fav => fav.movieId === movieId);
            const favButton = document.getElementById(`fav_${movieId}`);
            
            if (favButton) {
                if (isFavorite) {
                    favButton.classList.add('favorited');
                    favButton.querySelector('.fav-text').textContent = 'Remove from Favorites';
                } else {
                    favButton.classList.remove('favorited');
                    favButton.querySelector('.fav-text').textContent = 'Add to Favorites';
                }
            }
            
            return isFavorite;
        }

        // Update renderCinemas to check favorite status after rendering
        function updateFavoriteButtons() {
            Object.keys(movieDatabase).forEach(movieId => {
                checkFavoriteStatus(movieId);
            });
        }

        // Search and Filter Functions
        function searchMovies() {
            const searchTerm = document.getElementById('movieSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filterMovies();
                return;
            }

            const filteredCinemas = cinemas.filter(cinema => {
                const matchingMovies = cinema.movies.filter(movie => 
                    movie.title.toLowerCase().includes(searchTerm)
                );
                
                if (matchingMovies.length > 0) {
                    return true;
                }
                return false;
            }).map(cinema => {
                const matchingMovies = cinema.movies.filter(movie => 
                    movie.title.toLowerCase().includes(searchTerm)
                );
                return { ...cinema, movies: matchingMovies };
            });

            if (filteredCinemas.length === 0) {
                showNoResults(`No movies found matching "${searchTerm}"`);
            } else {
                renderCinemas(filteredCinemas);
            }
        }

        function filterMovies() {
            const genreFilter = document.getElementById('genreFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            const searchTerm = document.getElementById('movieSearch').value.toLowerCase().trim();

            let filteredCinemas = cinemas.filter(cinema => {
                let matchingMovies = cinema.movies;

                // Filter by search term
                if (searchTerm) {
                    matchingMovies = matchingMovies.filter(movie => 
                        movie.title.toLowerCase().includes(searchTerm)
                    );
                }

                // Filter by genre
                if (genreFilter) {
                    matchingMovies = matchingMovies.filter(movie => 
                        movie.genre.toLowerCase().includes(genreFilter.toLowerCase())
                    );
                }

                // Filter by rating
                if (ratingFilter) {
                    matchingMovies = matchingMovies.filter(movie => 
                        movie.rating >= parseFloat(ratingFilter)
                    );
                }

                if (matchingMovies.length > 0) {
                    cinema.filteredMovies = matchingMovies;
                    return true;
                }
                return false;
            }).map(cinema => ({
                ...cinema,
                movies: cinema.filteredMovies
            }));

            if (filteredCinemas.length === 0) {
                const filterDescription = [];
                if (searchTerm) filterDescription.push(`search term "${searchTerm}"`);
                if (genreFilter) filterDescription.push(`genre "${genreFilter}"`);
                if (ratingFilter) filterDescription.push(`rating ${ratingFilter}+`);
                
                showNoResults(`No movies found matching ${filterDescription.join(' and ')}`);
            } else {
                renderCinemas(filteredCinemas);
            }
        }

        function clearFilters() {
            document.getElementById('movieSearch').value = '';
            document.getElementById('genreFilter').value = '';
            document.getElementById('ratingFilter').value = '';
            renderCinemas();
        }

        function showNoResults(message) {
            const container = document.getElementById('cinemas-container');
            container.innerHTML = `
                <div class="no-results">
                    <h3>üé¨ No Results Found</h3>
                    <p>${message}</p>
                    <button onclick="clearFilters()" class="nav-button" style="margin-top: 20px;">Clear All Filters</button>
                </div>
            `;
        }

        // Handle Enter key in search input
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('movieSearch');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchMovies();
                    }
                });
            }
        });

        /* -------------------------
           Simple client-side auth
           ------------------------- */

        function getUsers() {
            try {
                return JSON.parse(localStorage.getItem('cinemaUsers') || '{}');
            } catch (e) {
                return {};
            }
        }

        function saveUsers(users) {
            localStorage.setItem('cinemaUsers', JSON.stringify(users));
        }

        function registerUser() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regPasswordConfirm').value;

            if (username.length === 0) { alert('Enter a username'); return; }
            if (password.length < 4) { alert('Password must be at least 4 characters'); return; }
            if (password !== confirm) { alert('Passwords do not match'); return; }

            const users = getUsers();
            if (users[username]) { alert('Username already exists'); return; }

            users[username] = { password }; // demo only: plain text in localStorage
            saveUsers(users);
            localStorage.setItem('loggedInUser', username);
            closeAuth();
            refreshAuthUI();
            alert('Registered and logged in as ' + username);
        }

        function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const users = getUsers();

            if (!users[username] || users[username].password !== password) {
                alert('Invalid username or password');
                return;
            }

            localStorage.setItem('loggedInUser', username);
            closeAuth();
            refreshAuthUI();
            alert('Logged in as ' + username);
        }

        function logoutUser() {
            localStorage.removeItem('loggedInUser');
            refreshAuthUI();
        }

        function openAuth(mode = 'login') {
            switchAuthTab(mode);
            document.getElementById('authModal').style.display = 'flex';
        }

        function closeAuth() {
            document.getElementById('authModal').style.display = 'none';
            // clear forms
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        function switchAuthTab(tab) {
            document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
            document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
            document.getElementById('loginForm').style.display = tab === 'login' ? '' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? '' : 'none';
        }

        function refreshAuthUI() {
            const authArea = document.getElementById('authArea');
            const user = localStorage.getItem('loggedInUser');
            if (user) {
                authArea.innerHTML = `
                    <a href="profile.html" class="nav-button">My Profile</a>
                    <button class="small-btn" onclick="logoutUser()">Logout</button>
                `;
            } else {
                authArea.innerHTML = `
                    <button class="small-btn" onclick="openAuth('login')">Login</button>
                    <button class="small-btn nav-button" onclick="openAuth('register')">Register</button>
                `;
            }
        }

        // simple escape to avoid injecting html into header
        function escapeHtml(str) {
            return String(str).replace(/[&<>"'\/]/g, function (s) {
                return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;' })[s];
            });
        }

    </script>
</body>
</html>
